import type { ProjectFiles } from '@/types';
import type { TemporalContext } from '@/lib/prompts/temporal-context';
import { getBaseRulesSection } from '@/lib/prompts/sections/base-rules';
import {
  buildCurrentWebsiteBlock,
  buildEditModeBlock,
  buildFirstGenerationBlock,
  buildTemporalBlock,
} from '@/lib/prompts/sections/context-blocks';
import { TOOL_OUTPUT_FORMAT_SECTION } from '@/lib/prompts/sections/tool-output-format';
import { UI_UX_GUIDELINES_SECTION } from '@/lib/prompts/sections/ui-ux-guidelines';

export interface SystemPromptParts {
  stable: string;
  dynamic: string;
}

const IDENTITY_LINE = `You are WebBuilder, an expert web designer and developer who creates distinctive, production-ready websites. You generate complete, self-contained HTML pages that look like they were designed by a professional, not generated by AI.`;

const CLOSING_LINE = `IMPORTANT: Be concise in your explanation. Focus on delivering excellent HTML.`;

/**
 * Returns the system prompt split into stable (cacheable) and dynamic parts.
 * The stable part contains the identity, base rules, UI/UX guidelines, and tool format â€”
 * content that rarely changes between requests. The dynamic part contains temporal context,
 * current website state, and edit mode instructions.
 */
export function getSystemPromptParts(
  currentFiles?: ProjectFiles,
  temporalContext?: TemporalContext,
  userPrompt?: string,
): SystemPromptParts {
  const isFirstGeneration = !currentFiles?.['index.html'];
  const toolSection = TOOL_OUTPUT_FORMAT_SECTION;

  const stable = `${IDENTITY_LINE}

${getBaseRulesSection(isFirstGeneration)}
${UI_UX_GUIDELINES_SECTION}
${toolSection}`;

  const dynamic = `${buildTemporalBlock(temporalContext)}${buildFirstGenerationBlock(isFirstGeneration, userPrompt)}${buildCurrentWebsiteBlock(currentFiles)}${buildEditModeBlock(currentFiles)}

${CLOSING_LINE}`;

  return { stable, dynamic };
}

export function getSystemPrompt(
  currentFiles?: ProjectFiles,
  temporalContext?: TemporalContext,
  userPrompt?: string,
): string {
  const { stable, dynamic } = getSystemPromptParts(currentFiles, temporalContext, userPrompt);
  return stable + '\n' + dynamic;
}
