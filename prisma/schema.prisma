generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Conversation {
  id                String            @id @default(cuid())
  title             String            @default("New Conversation")
  provider          String?           @map("provider")
  model             String?           @map("model")
  businessProfileId String?           @map("business_profile_id")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  messages          Message[]
  blueprint         Blueprint?
  generationState   GenerationState?
  businessProfile   BusinessProfile?  @relation(fields: [businessProfileId], references: [id])

  @@map("conversations")
}

model Blueprint {
  id             String       @id @default(cuid())
  conversationId String       @unique @map("conversation_id")
  data           Json
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("blueprints")
}

model GenerationState {
  id             String       @id @default(cuid())
  conversationId String       @unique @map("conversation_id")
  mode           String       // "chat" | "blueprint"
  phase          String       // Current phase in the generation pipeline

  // Chat mode
  autoSegment    Int?         @map("auto_segment")

  // Blueprint mode
  blueprintId    String?      @map("blueprint_id")
  componentHtml  Json?        @map("component_html")
  sharedStyles   Json?        @map("shared_styles")
  completedPages Json?        @map("completed_pages")
  pageStatuses   Json?        @map("page_statuses")

  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("generation_states")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  role           String
  content        String
  htmlArtifact   Json?        @map("html_artifact")
  isPartial      Boolean      @default(false) @map("is_partial")
  finishId       String?      @map("finish_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, finishId])
  @@map("messages")
}

model ApiKey {
  id           String   @id @default(cuid())
  provider     String   @unique
  encryptedKey String   @map("encrypted_key")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("api_keys")
}

model BusinessProfile {
  id             String   @id @default(cuid())
  name           String
  phone          String?
  email          String?
  website        String?
  address        String?
  lat            Float?
  lng            Float?
  placeId        String?  @map("place_id")
  category       String?
  categories     Json?
  hours          Json?
  services       Json?
  socialMedia    Json?    @map("social_media")
  additionalInfo String?  @map("additional_info")
  googleMapsUri  String?  @map("google_maps_uri")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  conversations  Conversation[]

  @@map("business_profiles")
}

model GenerationEvent {
  id              String   @id @default(cuid())
  conversationId  String?  @map("conversation_id")
  scope           String   // "chat", "blueprint-generate", "blueprint-components", "blueprint-pages", "blueprint-assets"
  provider        String
  model           String
  finishReason    String?  @map("finish_reason") // "stop", "length", "other", "aborted", "superseded"
  inputTokens     Int      @default(0) @map("input_tokens")
  outputTokens    Int      @default(0) @map("output_tokens")
  durationMs      Int      @map("duration_ms")
  toolCallCount   Int      @default(0) @map("tool_call_count")
  hasFileOutput   Boolean  @default(false) @map("has_file_output")
  repairTriggered Boolean  @default(false) @map("repair_triggered")
  textFallback    Boolean  @default(false) @map("text_fallback")
  costUsd         Float?   @map("cost_usd")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([conversationId])
  @@index([provider, model])
  @@index([createdAt])
  @@map("generation_events")
}
